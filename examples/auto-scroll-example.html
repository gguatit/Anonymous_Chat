<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자동 스크롤 기능 예제</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        #chatBox {
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 8px;
            overflow-y: auto;
            padding: 16px;
            position: relative;
        }

        #messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            padding: 10px 14px;
            background: #3a3a3a;
            border-radius: 6px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .status {
            text-align: center;
            margin: 20px auto;
            max-width: 600px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 6px;
            font-size: 14px;
        }

        .auto-scroll-status {
            color: #4ade80;
        }

        .manual-scroll-status {
            color: #fb923c;
        }
    </style>
</head>
<body>
    <div class="status">
        자동 스크롤: <span id="autoScrollStatus" class="auto-scroll-status">활성화</span>
        <br>
        <small>위로 스크롤하면 자동 스크롤이 비활성화되고, 맨 아래로 돌아오면 다시 활성화됩니다.</small>
    </div>

    <div id="chatBox">
        <div id="messages"></div>
    </div>

    <script>
        // DOM이 완전히 로드된 후 실행
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 요소 선택
            const chatBox = document.querySelector('#chatBox');
            const messagesContainer = document.querySelector('#messages');
            const autoScrollStatusElement = document.querySelector('#autoScrollStatus');

            // 자동 스크롤 제어 변수
            let autoScrollEnabled = true;
            const scrollThreshold = 50; // 하단에서 50px 이상 떨어지면 자동 스크롤 비활성화

            /**
             * 메시지를 추가하는 함수
             * @param {string} content - 메시지 내용
             */
            function addMessage(content) {
                // 새로운 메시지 요소 생성
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.textContent = content;

                // 메시지를 컨테이너에 추가
                messagesContainer.appendChild(messageDiv);

                // 자동 스크롤이 활성화되어 있을 때만 스크롤
                if (autoScrollEnabled) {
                    scrollToBottom();
                }
            }

            /**
             * 맨 아래로 스크롤하는 함수
             * @param {boolean} smooth - 부드러운 애니메이션 사용 여부
             */
            function scrollToBottom(smooth = false) {
                if (smooth) {
                    // 부드러운 스크롤 애니메이션
                    chatBox.scrollTo({
                        top: chatBox.scrollHeight,
                        behavior: 'smooth'
                    });
                } else {
                    // 즉시 스크롤
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }

            /**
             * 스크롤 위치를 확인하여 자동 스크롤 활성화/비활성화 결정
             */
            function checkScrollPosition() {
                // 현재 스크롤 관련 속성 가져오기
                const scrollTop = chatBox.scrollTop;
                const scrollHeight = chatBox.scrollHeight;
                const clientHeight = chatBox.clientHeight;

                // 현재 스크롤 위치가 하단에서 threshold 이내인지 확인
                // (scrollTop + clientHeight < scrollHeight - threshold) 조건으로 상단 탐색 여부 판별
                const isNearBottom = (scrollTop + clientHeight) >= (scrollHeight - scrollThreshold);

                if (isNearBottom) {
                    // 사용자가 맨 아래에 있으면 자동 스크롤 활성화
                    autoScrollEnabled = true;
                    updateAutoScrollStatus();
                } else {
                    // 사용자가 위로 스크롤했으면 자동 스크롤 비활성화
                    autoScrollEnabled = false;
                    updateAutoScrollStatus();
                }
            }

            /**
             * 자동 스크롤 상태 UI 업데이트
             */
            function updateAutoScrollStatus() {
                if (autoScrollEnabled) {
                    autoScrollStatusElement.textContent = '활성화';
                    autoScrollStatusElement.className = 'auto-scroll-status';
                } else {
                    autoScrollStatusElement.textContent = '비활성화 (위로 스크롤됨)';
                    autoScrollStatusElement.className = 'manual-scroll-status';
                }
            }

            // 스크롤 이벤트 리스너 등록
            chatBox.addEventListener('scroll', () => {
                checkScrollPosition();
            });

            // ==========================================
            // 프로덕션 환경에서는 아래 테스트 코드를 제거하세요
            // ==========================================
            
            // 실제 사용 예시를 위한 초기 메시지 (테스트용)
            addMessage('채팅방에 입장했습니다.');
            addMessage('자동 스크롤 기능이 활성화되어 있습니다.');
            
            // 새 메시지 추가 시뮬레이션 (테스트용 - 프로덕션에서는 제거)
            let messageCount = 1;
            const testInterval = setInterval(() => {
                addMessage(`메시지 ${messageCount}: ${new Date().toLocaleTimeString()}`);
                messageCount++;
                
                // 20개 메시지 후 테스트 중단
                if (messageCount > 20) {
                    clearInterval(testInterval);
                }
            }, 2000);

            // ==========================================
            // 프로덕션 사용법:
            // ==========================================
            // 
            // 1. 위의 테스트 코드(setInterval)를 제거하세요
            // 
            // 2. 실제 메시지 수신 시 addMessage() 호출:
            //    websocket.onmessage = (event) => {
            //        const data = JSON.parse(event.data);
            //        addMessage(data.content);
            //    };
            // 
            // 3. 또는 글로벌 함수로 노출하여 다른 모듈에서 사용:
            //    window.addChatMessage = addMessage;
            //
        });
    </script>
</body>
</html>
